<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced CMS System - Firebase Powered</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            text-decoration: none;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .status-bar {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .workflow-indicator {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .workflow-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border-radius: 15px;
            font-weight: 600;
            color: white;
            min-width: 180px;
            transition: transform 0.3s ease;
        }

        .workflow-step:hover {
            transform: translateY(-3px);
        }

        .step-hod {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .step-hop {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .step-fpr {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .step-active {
            box-shadow: 0 0 20px rgba(255,255,255,0.8);
            transform: scale(1.05);
        }

        .workflow-arrow {
            font-size: 1.5rem;
            color: #6c757d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .search-section {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .search-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-select {
            padding: 10px;
            border: 2px solid #e0e6ed;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: block;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            background: #e9ecef;
            border-color: #495057;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #e9ecef;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .requests-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .request-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .request-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .request-id {
            font-weight: 700;
            color: #2c3e50;
        }

        .request-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-hod {
            background: #d4edda;
            color: #155724;
        }

        .status-hop {
            background: #fff3cd;
            color: #856404;
        }

        .status-fpr {
            background: #f8d7da;
            color: #721c24;
        }

        .status-completed {
            background: #cce5ff;
            color: #004085;
        }

        .data-management {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 20px;
            border-radius: 15px;
        }

        .data-management h3 {
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .monthly-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.9);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .workflow-steps {
                flex-direction: column;
            }
            
            .monthly-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Back to Portfolio</a>
        
        <div class="header">
            <h1>🏗️ Enhanced CMS System</h1>
            <p>Firebase-Powered Content Management with Workflow</p>
        </div>

        <div class="status-bar">
            <div class="connection-status">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="connectionText">Connecting to Firebase...</span>
            </div>
            <div>
                <span id="lastSync">Never synced</span>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h3>🔍 Search & Filter Requests</h3>
            <input type="text" class="search-box" id="searchBox" placeholder="Search by Request ID, Title, Department, or Status...">
            <div class="search-filters">
                <select class="filter-select" id="departmentFilter">
                    <option value="">All Departments</option>
                    <option value="AXIS">AXIS Bank</option>
                    <option value="HDFC">HDFC Bank</option>
                    <option value="ICICI">ICICI Bank</option>
                    <option value="SBI">State Bank of India</option>
                    <option value="PNB">Punjab National Bank</option>
                    <option value="OTHER">Other</option>
                </select>
                <select class="filter-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="HOD">HOD Stage</option>
                    <option value="HOP">HOP Stage</option>
                    <option value="FPR">FPR Stage</option>
                    <option value="COMPLETED">Completed</option>
                </select>
                <select class="filter-select" id="priorityFilter">
                    <option value="">All Priorities</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
                <input type="date" class="filter-select" id="dateFilter">
            </div>
        </div>

        <!-- Workflow Indicator -->
        <div class="workflow-indicator">
            <div class="workflow-steps">
                <div class="workflow-step step-hod" id="stepHOD">
                    <div style="font-size: 1.2rem; margin-bottom: 5px;">📝</div>
                    <div>HOD (Maker)</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Create Request</div>
                </div>
                <div class="workflow-arrow">→</div>
                <div class="workflow-step step-hop" id="stepHOP">
                    <div style="font-size: 1.2rem; margin-bottom: 5px;">✅</div>
                    <div>HOP (Checker)</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Review & Approve</div>
                </div>
                <div class="workflow-arrow">→</div>
                <div class="workflow-step step-fpr" id="stepFPR">
                    <div style="font-size: 1.2rem; margin-bottom: 5px;">📊</div>
                    <div>Content Team FPR</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Final Processing</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Main Form Section -->
            <div class="form-section">
                <h2>📋 Content Request Form</h2>
                
                <form id="cmsForm">
                    <div class="form-group">
                        <label>Request ID</label>
                        <input type="text" class="form-control" id="requestId" readonly>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Department/Vertical *</label>
                            <select class="form-control" id="department" required>
                                <option value="">Select Department</option>
                                <option value="AXIS">AXIS Bank</option>
                                <option value="HDFC">HDFC Bank</option>
                                <option value="ICICI">ICICI Bank</option>
                                <option value="SBI">State Bank of India</option>
                                <option value="PNB">Punjab National Bank</option>
                                <option value="KOTAK">Kotak Mahindra Bank</option>
                                <option value="YES">YES Bank</option>
                                <option value="INDUSIND">IndusInd Bank</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Program Type *</label>
                            <select class="form-control" id="programType" required>
                                <option value="">Select Program Type</option>
                                <option value="Long Term">Long Term</option>
                                <option value="Short Term">Short Term</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="otherDepartmentGroup" style="display: none;">
                        <label>Other Department Name *</label>
                        <input type="text" class="form-control" id="otherDepartment">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Request Type *</label>
                            <select class="form-control" id="requestType" required>
                                <option value="">Select Request Type</option>
                                <option value="Creation">Creation</option>
                                <option value="Update">Update</option>
                                <option value="Review">Review</option>
                                <option value="Translation">Translation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority Level *</label>
                            <select class="form-control" id="priority" required>
                                <option value="">Select Priority</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Expected Deadline *</label>
                        <input type="date" class="form-control" id="deadline" required>
                    </div>

                    <div class="form-group">
                        <label>Brief Title *</label>
                        <input type="text" class="form-control" id="title" placeholder="Enter brief title for the content" required>
                    </div>

                    <div class="form-group">
                        <label>Content Description *</label>
                        <textarea class="form-control" id="description" rows="4" placeholder="Provide detailed description of the content requirements" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea class="form-control" id="notes" rows="3" placeholder="Any additional notes or special requirements"></textarea>
                    </div>

                    <!-- File Attachment Section -->
                    <div class="form-group">
                        <label>📎 File Attachments</label>
                        <div class="file-upload">
                            <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xlsx,.png,.jpg,.jpeg">
                            <label for="fileInput" class="file-upload-label">
                                <div>📁 Click to select files or drag and drop</div>
                                <div style="font-size: 0.9rem; color: #6c757d; margin-top: 5px;">
                                    Supported: PDF, DOC, DOCX, XLSX, PNG, JPG (Max 10MB each)
                                </div>
                            </label>
                        </div>
                        <div class="file-list" id="fileList"></div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">💾 Submit Request</button>
                        <button type="button" class="btn btn-warning" onclick="clearForm()">🔄 Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Data Management Section -->
                <div class="sidebar-section data-management">
                    <h3>📊 Data Management</h3>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalRequests">0</div>
                            <div class="stat-label">Total Requests</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="pendingRequests">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="completedRequests">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="monthlyRequests">0</div>
                            <div class="stat-label">This Month</div>
                        </div>
                    </div>

                    <div class="monthly-controls">
                        <input type="month" class="date-input" id="monthSelector">
                        <button class="btn btn-success btn-sm" onclick="downloadMonthlyData()">📅 Download Monthly</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn btn-warning btn-sm" onclick="exportAllData()">📊 Export All Data</button>
                        <button class="btn btn-primary btn-sm" onclick="sendEmailReport()">📧 Email Report</button>
                        <button class="btn btn-danger btn-sm" onclick="clearPastData()">🗑️ Clear Past Data</button>
                    </div>
                </div>

                <!-- Recent Requests -->
                <div class="sidebar-section">
                    <h3>📋 Recent Requests</h3>
                    <div class="requests-list" id="requestsList">
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            No requests found
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBfJxCZjSbfnkd8bUWr3z66QA4n-L2wM",
            authDomain: "amazing-pjts-by-team-content.firebaseapp.com",
            projectId: "amazing-pjts-by-team-content",
            storageBucket: "amazing-pjts-by-team-content.firebasestorage.app",
            messagingSenderId: "174140858851",
            appId: "1:174140858851:web:23ebed285df4cbfca180d6",
            measurementId: "G-9RZRHCLV69"
        };

        // Initialize Firebase
        let app, db, storage;
        let requests = [];
        let requestCounters = {};
        let selectedFiles = [];

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            storage = getStorage(app);
            updateConnectionStatus(true);
            initializeCMSApp();
        } catch (error) {
            console.error("Firebase initialization error:", error);
            updateConnectionStatus(false);
            showNotification('Firebase connection failed', 'error');
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'Connected to Firebase';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Offline Mode';
            }
        }

        function updateLastSync() {
            document.getElementById('lastSync').textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
        }

        async function initializeCMSApp() {
            await loadRequests();
            await loadCounters();
            setupRealtimeListener();
            updateStats();
            generateRequestId();
            setupEventListeners();
        }

        function setupRealtimeListener() {
            const requestsRef = collection(db, 'cms_requests');
            onSnapshot(requestsRef, (snapshot) => {
                requests = [];
                snapshot.forEach((doc) => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                console.log('Loaded requests:', requests.length); // Debug log
                displayRequests();
                updateStats();
                updateWorkflowIndicator();
                updateLastSync();
            }, (error) => {
                console.error("Error in real-time listener:", error);
                showNotification('Error loading real-time updates', 'error');
            });
        }

        function updateWorkflowIndicator() {
            // Reset all steps
            document.getElementById('stepHOD').classList.remove('step-active');
            document.getElementById('stepHOP').classList.remove('step-active');
            document.getElementById('stepFPR').classList.remove('step-active');

            // Count requests in each stage
            const hodCount = requests.filter(r => r.status === 'HOD').length;
            const hopCount = requests.filter(r => r.status === 'HOP').length;
            const fprCount = requests.filter(r => r.status === 'FPR').length;

            // Highlight active stages
            if (hodCount > 0) {
                document.getElementById('stepHOD').classList.add('step-active');
            }
            if (hopCount > 0) {
                document.getElementById('stepHOP').classList.add('step-active');
            }
            if (fprCount > 0) {
                document.getElementById('stepFPR').classList.add('step-active');
            }
        }

        async function loadRequests() {
            try {
                const q = query(collection(db, 'cms_requests'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                requests = [];
                querySnapshot.forEach((doc) => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                displayRequests();
                updateStats();
            } catch (error) {
                console.error("Error loading requests:", error);
                showNotification('Error loading requests', 'error');
            }
        }

        async function loadCounters() {
            try {
                const querySnapshot = await getDocs(collection(db, 'counters'));
                querySnapshot.forEach((doc) => {
                    requestCounters[doc.id] = doc.data().count || 0;
                });
            } catch (error) {
                console.error("Error loading counters:", error);
            }
        }

        function generateRequestId() {
            const department = document.getElementById('department').value;
            if (!department) return;

            const year = new Date().getFullYear();
            const currentCount = requestCounters[department] || 0;
            const newCount = currentCount + 1;
            const requestId = `${department}-${year}-${String(newCount).padStart(4, '0')}`;
            
            document.getElementById('requestId').value = requestId;
        }

        async function updateCounter(department) {
            try {
                const currentCount = requestCounters[department] || 0;
                const newCount = currentCount + 1;
                requestCounters[department] = newCount;
                
                await addDoc(collection(db, 'counters'), {
                    department: department,
                    count: newCount,
                    updatedAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error updating counter:", error);
            }
        }

        function setupEventListeners() {
            // Department change
            document.getElementById('department').addEventListener('change', function() {
                const otherGroup = document.getElementById('otherDepartmentGroup');
                if (this.value === 'OTHER') {
                    otherGroup.style.display = 'block';
                } else {
                    otherGroup.style.display = 'none';
                }
                generateRequestId();
            });

            // File input
            document.getElementById('fileInput').addEventListener('change', handleFileSelection);

            // Search and filters
            document.getElementById('searchBox').addEventListener('input', applyFilters);
            document.getElementById('departmentFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('priorityFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);

            // Form submission
            document.getElementById('cmsForm').addEventListener('submit', handleFormSubmission);
        }

        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            selectedFiles = [...selectedFiles, ...files];
            displayFileList();
        }

        function displayFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>📄 ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    <button type="button" onclick="removeFile(${index})" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 3px 8px;">✕</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            displayFileList();
        };

        async function uploadFiles(requestId) {
            const uploadPromises = selectedFiles.map(async (file, index) => {
                const storageRef = ref(storage, `cms-attachments/${requestId}/${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                return {
                    name: file.name,
                    url: downloadURL,
                    size: file.size,
                    type: file.type
                };
            });
            
            return await Promise.all(uploadPromises);
        }

        async function handleFormSubmission(event) {
            event.preventDefault();
            
            const formData = {
                requestId: document.getElementById('requestId').value,
                department: document.getElementById('department').value,
                programType: document.getElementById('programType').value,
                requestType: document.getElementById('requestType').value,
                priority: document.getElementById('priority').value,
                deadline: document.getElementById('deadline').value,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                notes: document.getElementById('notes').value,
                otherDepartment: document.getElementById('otherDepartment').value,
                status: 'HOD',
                stage: 'HOD',
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };

            try {
                showNotification('Uploading files and saving request...', 'warning');
                
                // Upload files if any
                let attachments = [];
                if (selectedFiles.length > 0) {
                    attachments = await uploadFiles(formData.requestId);
                }
                
                formData.attachments = attachments;

                // Save to Firebase
                const docRef = await addDoc(collection(db, 'cms_requests'), formData);
                console.log('Request saved with ID:', docRef.id); // Debug log
                
                // Update counter
                await updateCounter(formData.department);
                
                showNotification('Request submitted successfully!', 'success');
                clearForm();
                
                // Force refresh data
                await loadRequests();
                
            } catch (error) {
                console.error("Error submitting request:", error);
                showNotification('Error submitting request', 'error');
            }
        }

        function displayRequests() {
            const container = document.getElementById('requestsList');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        No requests found
                    </div>
                `;
                return;
            }

            const filteredRequests = getFilteredRequests();
            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        No matching requests
                    </div>
                `;
                return;
            }

            const requestsHTML = filteredRequests.slice(0, 10).map(request => `
                <div class="request-item">
                    <div class="request-header">
                        <div class="request-id">${request.requestId || 'No ID'}</div>
                        <div class="request-status status-${(request.status || 'hod').toLowerCase()}">
                            ${request.status || 'HOD'}
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; margin-bottom: 5px;">
                        <strong>${request.title || 'No Title'}</strong>
                    </div>
                    <div style="font-size: 0.8rem; color: #6c757d;">
                        ${request.department || 'No Dept'} | ${request.priority || 'Medium'} Priority
                    </div>
                    <div style="font-size: 0.8rem; color: #6c757d;">
                        ${request.createdAt ? new Date(request.createdAt.toDate()).toLocaleDateString() : new Date().toLocaleDateString()}
                    </div>
                    ${request.attachments && request.attachments.length > 0 ? 
                        `<div style="font-size: 0.8rem; color: #667eea;">📎 ${request.attachments.length} file(s)</div>` 
                        : ''}
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;" onclick="viewRequest('${request.id}')">👁️ View</button>
                        <button class="btn btn-warning" style="padding: 6px 12px; font-size: 0.8rem; margin-right: 5px;" onclick="moveToNextStage('${request.id}')">➡️ Next Stage</button>
                        ${request.attachments && request.attachments.length > 0 ? 
                            `<button class="btn btn-success" style="padding: 6px 12px; font-size: 0.8rem;" onclick="downloadAttachments('${request.id}')">📎 Files</button>` 
                            : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = requestsHTML;
        }

        function getFilteredRequests() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const departmentFilter = document.getElementById('departmentFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            return requests.filter(request => {
                const matchesSearch = !searchTerm || 
                    request.requestId.toLowerCase().includes(searchTerm) ||
                    request.title.toLowerCase().includes(searchTerm) ||
                    request.department.toLowerCase().includes(searchTerm) ||
                    request.status.toLowerCase().includes(searchTerm);

                const matchesDepartment = !departmentFilter || request.department === departmentFilter;
                const matchesStatus = !statusFilter || request.status === statusFilter;
                const matchesPriority = !priorityFilter || request.priority === priorityFilter;
                
                let matchesDate = true;
                if (dateFilter && request.createdAt) {
                    const requestDate = new Date(request.createdAt.toDate()).toISOString().split('T')[0];
                    matchesDate = requestDate === dateFilter;
                }

                return matchesSearch && matchesDepartment && matchesStatus && matchesPriority && matchesDate;
            });
        }

        function applyFilters() {
            displayRequests();
        }

        function updateStats() {
            const total = requests.length;
            const pending = requests.filter(r => r.status !== 'COMPLETED').length;
            const completed = requests.filter(r => r.status === 'COMPLETED').length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthly = requests.filter(r => {
                if (!r.createdAt) return false;
                const date = new Date(r.createdAt.toDate());
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).length;

            document.getElementById('totalRequests').textContent = total;
            document.getElementById('pendingRequests').textContent = pending;
            document.getElementById('completedRequests').textContent = completed;
            document.getElementById('monthlyRequests').textContent = monthly;
        }

        window.clearForm = function() {
            document.getElementById('cmsForm').reset();
            selectedFiles = [];
            displayFileList();
            generateRequestId();
        };

        window.viewRequest = function(requestId) {
            const request = requests.find(r => r.id === requestId);
            if (!request) return;

            let attachmentsList = '';
            if (request.attachments && request.attachments.length > 0) {
                attachmentsList = request.attachments.map(att => 
                    `<a href="${att.url}" target="_blank" style="color: #667eea; text-decoration: none;">📄 ${att.name}</a>`
                ).join('<br>');
            }

            const details = `
                <strong>Request ID:</strong> ${request.requestId}<br>
                <strong>Department:</strong> ${request.department}<br>
                <strong>Program Type:</strong> ${request.programType}<br>
                <strong>Request Type:</strong> ${request.requestType}<br>
                <strong>Priority:</strong> ${request.priority}<br>
                <strong>Deadline:</strong> ${request.deadline}<br>
                <strong>Title:</strong> ${request.title}<br>
                <strong>Description:</strong> ${request.description}<br>
                <strong>Status:</strong> ${request.status}<br>
                ${request.notes ? `<strong>Notes:</strong> ${request.notes}<br>` : ''}
                ${attachmentsList ? `<br><strong>Attachments:</strong><br>${attachmentsList}` : ''}
            `;

            alert(details);
        };

        window.moveToNextStage = async function(requestId) {
            const request = requests.find(r => r.id === requestId);
            if (!request) return;

            let nextStatus;
            let actionMessage;

            switch (request.status) {
                case 'HOD':
                    nextStatus = 'HOP';
                    actionMessage = 'Move to HOP (Checker) stage?';
                    break;
                case 'HOP':
                    nextStatus = 'FPR';
                    actionMessage = 'Approve and move to FPR (Final Processing) stage?';
                    break;
                case 'FPR':
                    nextStatus = 'COMPLETED';
                    actionMessage = 'Mark as completed and generate Excel export?';
                    break;
                case 'COMPLETED':
                    showNotification('Request is already completed', 'warning');
                    return;
                default:
                    nextStatus = 'HOP';
                    actionMessage = 'Move to next stage?';
            }

            if (confirm(actionMessage)) {
                try {
                    await updateRequestStatus(requestId, nextStatus);
                    
                    // If moving to completed, trigger export
                    if (nextStatus === 'COMPLETED') {
                        generateExcelExport(request);
                    }
                    
                    showNotification(`Request moved to ${nextStatus} stage successfully!`, 'success');
                } catch (error) {
                    console.error("Error moving to next stage:", error);
                    showNotification('Error updating request status', 'error');
                }
            }
        };

        async function generateExcelExport(request) {
            try {
                // Create Excel data
                const excelData = [{
                    'Request ID': request.requestId,
                    'Department': request.department,
                    'Program Type': request.programType,
                    'Request Type': request.requestType,
                    'Priority': request.priority,
                    'Deadline': request.deadline,
                    'Title': request.title,
                    'Description': request.description,
                    'Status': 'COMPLETED',
                    'Completed Date': new Date().toLocaleDateString(),
                    'Notes': request.notes || '',
                    'Attachments': request.attachments ? request.attachments.length + ' files' : 'No files'
                }];

                const csvData = convertToCSV(excelData);
                downloadCSV(csvData, `Completed_Request_${request.requestId}_${new Date().toISOString().split('T')[0]}.csv`);
                
                showNotification('Excel export generated successfully!', 'success');
            } catch (error) {
                console.error("Error generating export:", error);
                showNotification('Error generating export', 'error');
            }
        }

        async function updateRequestStatus(requestId, newStatus) {
            try {
                const requestRef = doc(db, 'cms_requests', requestId);
                await updateDoc(requestRef, {
                    status: newStatus,
                    stage: newStatus,
                    updatedAt: serverTimestamp()
                });
                showNotification('Status updated successfully!', 'success');
            } catch (error) {
                console.error("Error updating status:", error);
                showNotification('Error updating status', 'error');
            }
        }

        window.downloadAttachments = function(requestId) {
            const request = requests.find(r => r.id === requestId);
            if (!request || !request.attachments) return;

            request.attachments.forEach(attachment => {
                const link = document.createElement('a');
                link.href = attachment.url;
                link.download = attachment.name;
                link.click();
            });
        };

        window.exportAllData = function() {
            if (requests.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }

            const csvData = convertToCSV(requests);
            downloadCSV(csvData, `CMS_All_Requests_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification('Data exported successfully!', 'success');
        };

        window.downloadMonthlyData = function() {
            const monthSelector = document.getElementById('monthSelector');
            const selectedMonth = monthSelector.value;
            
            if (!selectedMonth) {
                showNotification('Please select a month', 'warning');
                return;
            }

            const [year, month] = selectedMonth.split('-').map(Number);
            const monthlyRequests = requests.filter(r => {
                if (!r.createdAt) return false;
                const date = new Date(r.createdAt.toDate());
                return date.getFullYear() === year && (date.getMonth() + 1) === month;
            });

            if (monthlyRequests.length === 0) {
                showNotification('No data found for selected month', 'warning');
                return;
            }

            const csvData = convertToCSV(monthlyRequests);
            downloadCSV(csvData, `CMS_Monthly_${selectedMonth}_Requests.csv`);
            showNotification('Monthly data downloaded!', 'success');
        };

        window.sendEmailReport = function() {
            const monthlyRequests = requests.filter(r => {
                if (!r.createdAt) return false;
                const date = new Date(r.createdAt.toDate());
                const now = new Date();
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            });

            const emailBody = `Monthly CMS Report - ${new Date().toLocaleDateString()}
            
Total Requests This Month: ${monthlyRequests.length}
Completed: ${monthlyRequests.filter(r => r.status === 'COMPLETED').length}
Pending: ${monthlyRequests.filter(r => r.status !== 'COMPLETED').length}

Recent Requests:
${monthlyRequests.slice(0, 5).map(r => `- ${r.requestId}: ${r.title} (${r.status})`).join('\n')}

Full report attached as CSV file.`;

            const mailtoLink = `mailto:?subject=CMS Monthly Report&body=${encodeURIComponent(emailBody)}`;
            window.open(mailtoLink);
            
            showNotification('Email draft opened! Attach the CSV export.', 'success');
        };

        window.clearPastData = function() {
            if (!confirm('⚠️ This will permanently delete all requests older than 3 months. Are you sure?')) {
                return;
            }

            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

            const oldRequests = requests.filter(r => {
                if (!r.createdAt) return false;
                return new Date(r.createdAt.toDate()) < threeMonthsAgo;
            });

            if (oldRequests.length === 0) {
                showNotification('No old data to clear', 'warning');
                return;
            }

            if (confirm(`Found ${oldRequests.length} old requests. Proceed with deletion?`)) {
                deleteOldRequests(oldRequests);
            }
        };

        async function deleteOldRequests(oldRequests) {
            try {
                const deletePromises = oldRequests.map(request => 
                    deleteDoc(doc(db, 'cms_requests', request.id))
                );
                await Promise.all(deletePromises);
                showNotification(`${oldRequests.length} old requests deleted successfully!`, 'success');
            } catch (error) {
                console.error("Error deleting old requests:", error);
                showNotification('Error deleting old requests', 'error');
            }
        }

        function convertToCSV(data) {
            const headers = [
                'Request ID', 'Department', 'Program Type', 'Request Type', 'Priority',
                'Deadline', 'Title', 'Description', 'Status', 'Created Date', 'Attachments'
            ];

            const csvRows = [headers.join(',')];
            
            data.forEach(request => {
                const row = [
                    `"${request.requestId}"`,
                    `"${request.department}"`,
                    `"${request.programType}"`,
                    `"${request.requestType}"`,
                    `"${request.priority}"`,
                    `"${request.deadline}"`,
                    `"${request.title?.replace(/"/g, '""') || ''}"`,
                    `"${request.description?.replace(/"/g, '""') || ''}"`,
                    `"${request.status}"`,
                    `"${request.createdAt ? new Date(request.createdAt.toDate()).toLocaleDateString() : ''}"`,
                    `"${request.attachments ? request.attachments.length + ' files' : 'No files'}"`
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        function downloadCSV(csvData, filename) {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Initialize month selector
        document.addEventListener('DOMContentLoaded', function() {
            const monthSelector = document.getElementById('monthSelector');
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            monthSelector.value = currentMonth;
        });
    </script>
</body>
</html>
